name: Build Android

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Build profile"
        required: true
        default: "production"
        type: choice
        options:
          - preview
          - production
  pull_request:
    types: [opened, synchronize]

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: 🏗 Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: 🏗 Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: ">= 13.1.0"
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: bun install --frozen-lockfile

      - name: 🔐 Setup Sentry properties
        run: |
          echo "auth.token=${{ secrets.SENTRY_AUTH_TOKEN }}" >> android/sentry.properties

      - name: 🚀 Build Android
        id: build
        run: |
          PROFILE=${{ github.event.inputs.profile || 'preview' }}
          echo "Building Android with profile: $PROFILE"

          # Build locally
          eas build --platform android --profile $PROFILE --local --non-interactive

          # Find generated files
          APK_PATH=$(find . -name "*.apk" -type f | head -1)
          AAB_PATH=$(find . -name "*.aab" -type f | head -1)

          if [ -n "$APK_PATH" ]; then
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "✅ APK: $APK_PATH"
          fi

          if [ -n "$AAB_PATH" ]; then
            echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
            echo "✅ AAB: $AAB_PATH"
          fi

          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT

      - name: 📱 Upload APK
        if: steps.build.outputs.apk_path
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.build.outputs.profile }}-${{ steps.build.outputs.timestamp }}
          path: ${{ steps.build.outputs.apk_path }}
          retention-days: 30

      - name: 📱 Upload AAB
        if: steps.build.outputs.aab_path
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ steps.build.outputs.profile }}-${{ steps.build.outputs.timestamp }}
          path: ${{ steps.build.outputs.aab_path }}
          retention-days: 30

      - name: 🏷️ Create Release
        if: steps.build.outputs.apk_path || steps.build.outputs.aab_path
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-${{ steps.build.outputs.profile }}-${{ steps.build.outputs.timestamp }}
          name: Android ${{ steps.build.outputs.profile }} - ${{ steps.build.outputs.timestamp }}
          body: |
            🤖 **Android Build**

            **Profile:** ${{ steps.build.outputs.profile }}
            **Built:** ${{ steps.build.outputs.timestamp }}

            Downloads:
            ${{ steps.build.outputs.apk_path && '- APK for direct install' || '' }}
            ${{ steps.build.outputs.aab_path && '- AAB for Play Store' || '' }}
          files: |
            ${{ steps.build.outputs.apk_path }}
            ${{ steps.build.outputs.aab_path }}
          draft: false
          prerelease: ${{ steps.build.outputs.profile != 'production' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
