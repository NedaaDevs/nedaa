name: Build iOS

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Build profile"
        required: true
        default: "production"
        type: choice
        options:
          - preview
          - production
  pull_request:
    types: [opened, synchronize]

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest

    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: 🏗 Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: ">= 13.1.0"
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: bun install --frozen-lockfile

      - name: 🔐 Setup Sentry properties
        run: |
          echo "auth.token=${{ secrets.SENTRY_AUTH_TOKEN }}" >> ios/sentry.properties

      - name: 🍎 Build iOS
        id: build
        run: |
          PROFILE=${{ github.event.inputs.profile || 'preview' }}
          echo "Building iOS with profile: $PROFILE"

          # Build locally
          eas build --platform ios --profile $PROFILE --local --non-interactive

          # Find generated IPA
          IPA_PATH=$(find . -name "*.ipa" -type f | head -1)

          if [ -n "$IPA_PATH" ]; then
            echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
            echo "✅ IPA: $IPA_PATH"
          else
            echo "❌ No IPA found"
            exit 1
          fi

          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT

      - name: 📱 Upload IPA
        if: steps.build.outputs.ipa_path
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ steps.build.outputs.profile }}-${{ steps.build.outputs.timestamp }}
          path: ${{ steps.build.outputs.ipa_path }}
          retention-days: 30

      - name: 🏷️ Create Release
        if: steps.build.outputs.ipa_path
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ios-${{ steps.build.outputs.profile }}-${{ steps.build.outputs.timestamp }}
          name: iOS ${{ steps.build.outputs.profile }} - ${{ steps.build.outputs.timestamp }}
          body: |
            🍎 **iOS Build**

            **Profile:** ${{ steps.build.outputs.profile }}
            **Built:** ${{ steps.build.outputs.timestamp }}

            Download IPA for TestFlight or enterprise distribution.
          files: ${{ steps.build.outputs.ipa_path }}
          draft: false
          prerelease: ${{ steps.build.outputs.profile != 'production' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
